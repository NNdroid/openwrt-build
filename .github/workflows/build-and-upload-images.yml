name: Build and Upload Images

on:
#  push:
#    branches: [ "main" ]
#  pull_request:
#    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '10 13 * * *'

permissions:
  contents: write

jobs:
  build:
    name: Build on Ubuntu 24.04
    runs-on: ubuntu-24.04
    # ã€ä¿®å¤ 1ã€‘: ç§»é™¤ container å—
    # ç›´æ¥åœ¨ VM Host ä¸Šè¿è¡Œï¼Œé¿å… "å®¹å™¨å†…å¥—å®¹å™¨" æˆ– "å®¹å™¨å†…ä¿®æ”¹å†…æ ¸å‚æ•°" çš„æƒé™é—®é¢˜ã€‚
    # Armbian è„šæœ¬é€šå¸¸ä¼šè‡ªåŠ¨æ‹‰å–å®ƒéœ€è¦çš„ Docker ç¯å¢ƒï¼Œæˆ–è€…åˆ©ç”¨ Host ç¯å¢ƒã€‚

    steps:
      - name: Checkout Upstream to Check Tags (Schedule only)
        if: github.event_name == 'schedule'
        # ğŸ‘‡ è¿™ä¸ª Token æ˜¯å¿…é¡»çš„ï¼Œå®ƒæ˜¯ä¸ºäº†è®© 'gh run cancel' æœ‰æƒé™å–æ¶ˆå½“å‰ä»»åŠ¡
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Cloning upstream repo metadata..."
          
          # 1. æµ…å…‹éš† (å…¬å¼€ä»“åº“ä¸éœ€è¦ Token)
          git clone --bare --filter=blob:none https://github.com/openwrt/openwrt.git upstream_check
          
          cd upstream_check
          
          # 2. è·å–æ•°æ®
          LATEST_TAG_INFO=$(git for-each-ref --sort=-creatordate --format='%(creatordate:unix) %(refname:short)' refs/tags | head -n 1)
          
          if [ -z "$LATEST_TAG_INFO" ]; then
             echo "Error: No tags found."
             cd ..
             rm -rf upstream_check
             exit 1
          fi
          
          TAG_TIMESTAMP=$(echo "$LATEST_TAG_INFO" | awk '{print $1}')
          TAG_NAME=$(echo "$LATEST_TAG_INFO" | awk '{print $2}')
          TAG_DATE=$(date -d @$TAG_TIMESTAMP +'%Y-%m-%d %H:%M:%S')
          
          # 3. æ¸…ç†
          cd ..
          rm -rf upstream_check
          
          echo "Latest Upstream Tag: $TAG_NAME ($TAG_DATE)"
          
          # 4. åˆ¤æ–­é€»è¾‘
          NOW_TIMESTAMP=$(date +%s)
          DIFF=$((NOW_TIMESTAMP - TAG_TIMESTAMP))
          
          if [ "$DIFF" -gt 86400 ]; then
            echo "Result: Latest tag is older than 24 hours. Skipping build."
            echo "Cancelling this workflow run..."
            # ğŸ‘‡ å°±æ˜¯è¿™è¡Œå‘½ä»¤éœ€è¦ GH_TOKEN
            gh run cancel ${{ github.run_id }}
            sleep 60
          else
            echo "Result: New tag found within 24 hours. Proceeding..."
          fi

      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # --- ä¿®æ­£ï¼šæ¸…ç†ç£ç›˜ç©ºé—´ ---
      - name: Free Disk Space (Ubuntu)
        # ä¿®æ­£äº†ä»“åº“åç§°ï¼šå»æ‰æœ«å°¾çš„ "-action"
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          # é‡Šæ”¾ Android åº“ (çº¦ 10GB)
          android: true
          # é‡Šæ”¾ .NET è¿è¡Œåº“ (çº¦ 2GB)
          dotnet: true
          # é‡Šæ”¾ Haskell (çº¦ 3GB)
          haskell: true
          # é‡Šæ”¾å¾ˆå¤§çš„ Docker é•œåƒ (çº¦ 3GB)
          docker-images: true
          # é‡Šæ”¾ CodeQL åˆ†æå·¥å…· (çº¦ 2GB)
          tool-cache: true
          # é‡Šæ”¾ Swap åˆ†åŒº (è¿™ä¼šå¢åŠ å†…å­˜å‹åŠ›ï¼Œå¦‚æœå†…å­˜ä¸å¤Ÿå°±è®¾ä¸º false)
          swap-storage: false
      # ------------------------

      # ã€ä¿®å¤ 2ã€‘: ä½¿ç”¨å®˜æ–¹ Action é…ç½® QEMU
      # è¿™ä¼šåœ¨å†…æ ¸å±‚é¢æ³¨å†Œ ARM64, RISCV ç­‰æ¶æ„çš„æ¨¡æ‹Ÿå™¨ã€‚
      # è¿™æ ·å½“è„šæœ¬è¿è¡Œ "arch-test arm64" æ—¶å°±ä¼šé€šè¿‡ï¼Œä¸å†æŠ¥é”™ã€‚
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 2. å®‰è£…åŸºç¡€ä¾èµ–
      # è™½ç„¶åœ¨ VM ä¸Šï¼Œä½†ä¸ºäº†è„šæœ¬èƒ½è·‘èµ·æ¥ï¼Œè¿˜æ˜¯é¢„è£…ä¸€äº›åŸºç¡€åŒ…
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl wget sudo qemu-user-static

      # 3. èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
      - name: Make script executable
        run: chmod +x build.sh

      # 4. æ‰§è¡Œæ„å»ºè„šæœ¬
      # åŠ ä¸Š sudoï¼ŒArmbian æ„å»ºè¿‡ç¨‹æ¶‰åŠ loop è®¾å¤‡æŒ‚è½½ï¼Œå¿…é¡»è¦æœ‰ root æƒé™
      - name: Run build script
        run: ./build.sh

      # 6. (æ–°å¢æ­¥éª¤) å‡†å¤‡ç‰ˆæœ¬å·å’Œæ–‡ä»¶å
      - name: Prepare Release MetaData
        id: metadata
        if: success()
        run: |
          # 2. æå–ç‰ˆæœ¬å·
          VERSION=$(git -C ./openwrt describe --tags --exact-match)
          
          # 3. è·å–æ—¥æœŸ
          DATE=$(date +%Y%m%d)
          
          # 4. ç»„åˆ Tag å’Œ Name
          TAG_NAME="${VERSION}-${DATE}"
          RELEASE_NAME="OpenWrt ${VERSION} Build ${DATE}"
          
          echo "Calculated Tag: $TAG_NAME"
          
          # 5. å†™å…¥ GitHub Output
          echo "release_tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          
          # å¤šè¡Œæ–‡æœ¬å†™å…¥ Output çš„æ ‡å‡†å†™æ³•
          echo "release_commit_log<<EOF" >> $GITHUB_OUTPUT
          git -C ./openwrt log -1 --date=format:'%Y-%m-%d %H:%M:%S' --format="[%h](https://github.com/openwrt/openwrt/commit/%H) (%cd) by %an: %s" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "time=$(date +'%H:%M:%S')" >> $GITHUB_OUTPUT

      # 7. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: built-images
          path: openwrt/result/*
          retention-days: 5

      # 8. å‘å¸ƒåˆ° GitHub Release
      - name: Generate Release Tag & Upload
        if: github.ref == 'refs/heads/main' && success()
        uses: softprops/action-gh-release@v2
        with:
          files: openwrt/result/*
          body: |
            ### Build Information
            - Commit Hash: ${{ steps.metadata.outputs.release_commit_log }}
            - Build Time: ${{ steps.metadata.outputs.date }} ${{ steps.metadata.outputs.time }}
          tag_name: ${{ steps.metadata.outputs.release_tag }}
          name: ${{ steps.metadata.outputs.release_name }}
          make_latest: true
          draft: false
          prerelease: false
